{% extends "base.html" %}
{% block title %}Group{% endblock %}
{% block head %}
    {{ super() }}
    <style type="text/css">
        .important { color: #336699; }
    </style>
{% endblock %}
{% block content %}

<h2>{{group.name}}</h2>

{% if group.registering %}
	{% if not joined %}
	<p>You are not currently registered for this group. If you would like to join, <a href="/group/{{group.name}}/join">click here</a>.</p>
	{% else %}
	<p>Alright! You're all signed up. We're waiting on the rest of the crew to sign up, and then you can fill in your preferences.</p>
	{% endif %}
{% else %}
	{% if not joined %}
		<p>I'm sorry, registration for this group is closed.</p>
	{% else %}
		{% if target %}
			<p>You are the Secret Ssanta for <strong>{{target}}</strong></p>!</p>
		{% else %}
			
			<p>Welcome back. We need you to write your list for your Santa. Also, you can specify up to two people as folks whom you do <strong>not</strong> want to be Santa for.</p>

			<div class="form-group" id="messageBlock">
		      	<label for="message">Write a message to your Secret Santa about how good you've been and what you want.</label>
				<textarea id="message" class="form-control" rows="3">Message for Santa</textarea>
			</div>

			<label for="prohibited">Who do you want to be Santa for? You may uncheck up to two people. The elves won't tell.</label>
			<div id="prohibited" class="form-group">
				{% for person in others %}
		      	<div class="checkbox">
				  <label>
				    <input class="prohibited" type="checkbox" value="{{person.key.urlsafe()}}" checked>
				    {{person.name}}
				  </label>
				</div>
				{% endfor %}
			</div>

		    <button id="ready" type="submit" class="btn btn-primary">I'm ready</button>
		{% endif %}
	{% endif %}
{% endif %}

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function(){
    $("#message").click(function(obj){
    	if ($(this).attr("reset")) {
    		return;
    	}
        $(this).val("");
        $(this).attr("reset", true);
    });

    $("#ready").click(function(){
    	// Verify no more than two selected
    	unchecked = []
    	$(".prohibited:checkbox").each(function(){
    		unchecked.push($(this).val())
    	});

		$(".prohibited:checkbox:checked").each(function(){
			var idx = unchecked.indexOf($(this).val());
		    if (idx !== -1) {
		        unchecked.splice(idx, 1);
		    }
    	});
    	
		if (unchecked.length > 2) {
			$("#prohibited").addClass("has-error");
			return;
		} else {
			$("#prohibited").removeClass("has-error");
		}

		// Verify the message got set
		if (! $("#message").attr("reset")) {
			$("#messageBlock").addClass("has-error");
			return;
		} else {
			$("#messageBlock").removeClass("has-error");
		}

    	// Package up the data
    	data = {}

    	data["message"] = $("#message").val();
    	if (unchecked.length > 0) {
    		data["unchecked0"] = unchecked[0];
    	}
    	if (unchecked.length > 1) {
    		data["unchecked1"] = unchecked[1];
    	}

    	$.post("/group/{{group.name}}/ready", data, function(){
    		window.location.replace("/");
    	});

    });
});

</script>
{% endblock %}